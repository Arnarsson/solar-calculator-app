---
phase: 01-foundation
plan: 07
type: execute
wave: 4
depends_on: ["01-05", "01-06"]
files_modified:
  - app/calculator/page.tsx
  - components/calculator/Calculator.tsx
  - components/calculator/MethodologyPanel.tsx
  - app/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can access calculator at /calculator route"
    - "Calculator shows inputs on left, results on right (responsive)"
    - "User can see documented assumptions in methodology panel"
    - "All Phase 1 success criteria are met and verifiable"
  artifacts:
    - path: "app/calculator/page.tsx"
      provides: "Calculator page route"
    - path: "components/calculator/Calculator.tsx"
      provides: "Main calculator layout component"
    - path: "components/calculator/MethodologyPanel.tsx"
      provides: "Assumptions and formula documentation"
  key_links:
    - from: "app/calculator/page.tsx"
      to: "components/calculator/Calculator.tsx"
      via: "renders Calculator component"
      pattern: "Calculator"
    - from: "components/calculator/Calculator.tsx"
      to: "components/calculator/CalculatorTabs.tsx"
      via: "renders input tabs"
      pattern: "CalculatorTabs"
    - from: "components/calculator/Calculator.tsx"
      to: "components/calculator/CalculatorResults.tsx"
      via: "renders results"
      pattern: "CalculatorResults"
---

<objective>
Wire calculator components together into working page with methodology documentation.

Purpose: This is the integration plan that brings inputs and outputs together into a complete calculator experience. Includes the methodology panel that documents all assumptions for transparency (FIN-06).

Output: Working calculator at /calculator route with full Phase 1 functionality.
</objective>

<execution_context>
@/home/sven/.claude/get-shit-done/workflows/execute-plan.md
@/home/sven/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-and-core-calculations/CONTEXT.md

@components/calculator/CalculatorTabs.tsx (from Plan 05)
@components/calculator/CalculatorResults.tsx (from Plan 06)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create methodology panel with documented assumptions</name>
  <files>
    components/calculator/MethodologyPanel.tsx
  </files>
  <action>
Create components/calculator/MethodologyPanel.tsx:

```typescript
'use client';

import { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from '@/components/ui/accordion';
import { BookOpen, ExternalLink } from 'lucide-react';

export function MethodologyPanel() {
  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <BookOpen className="h-5 w-5" />
          Beregningsmetode og forudsætninger
        </CardTitle>
      </CardHeader>
      <CardContent>
        <Accordion type="single" collapsible className="w-full">
          <AccordionItem value="production">
            <AccordionTrigger>Produktionsberegning</AccordionTrigger>
            <AccordionContent className="space-y-3 text-sm">
              <p>
                Årlig produktion estimeres via{' '}
                <a
                  href="https://re.jrc.ec.europa.eu/pvg_tools/"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-primary hover:underline inline-flex items-center gap-1"
                >
                  EU PVGIS <ExternalLink className="h-3 w-3" />
                </a>
                , som bruger satellitdata for solindstråling på din specifikke placering.
              </p>

              <div className="bg-muted p-3 rounded-md font-mono text-xs">
                <p>// Grundformel</p>
                <p>Årlig produktion (kWh) = Systemstørrelse (kWp) × Solindstråling (kWh/kWp/år) × Ydeevnefaktor</p>
                <p className="mt-2">// Eksempel for København</p>
                <p>5 kWp × 1000 kWh/kWp × 0.8 = 4000 kWh/år</p>
              </div>

              <p className="text-muted-foreground">
                <strong>Ydeevnefaktor (80%):</strong> Tager højde for tab i kabler, inverter, støv, og temperatur.
              </p>
            </AccordionContent>
          </AccordionItem>

          <AccordionItem value="degradation">
            <AccordionTrigger>Panel-degradering</AccordionTrigger>
            <AccordionContent className="space-y-3 text-sm">
              <p>Solceller mister gradvist effektivitet over tid:</p>

              <ul className="list-disc list-inside space-y-1">
                <li>
                  <strong>År 1:</strong> 3% tab (Light-Induced Degradation - LID)
                </li>
                <li>
                  <strong>År 2-25:</strong> 0,5% tab pr. år
                </li>
              </ul>

              <div className="bg-muted p-3 rounded-md font-mono text-xs">
                <p>// År 1</p>
                <p>Produktion = Basis × 0,97</p>
                <p className="mt-2">// År N (N {'>'} 1)</p>
                <p>Produktion = Basis × 0,97 × 0,995^(N-1)</p>
                <p className="mt-2">// Efter 25 år</p>
                <p>Produktion ≈ Basis × 0,97 × 0,886 ≈ 86% af original</p>
              </div>

              <p className="text-muted-foreground">
                Kilde: Industristandard baseret på producent-garantier (typisk 80% efter 25 år).
              </p>
            </AccordionContent>
          </AccordionItem>

          <AccordionItem value="financial">
            <AccordionTrigger>Økonomiske beregninger</AccordionTrigger>
            <AccordionContent className="space-y-3 text-sm">
              <p><strong>Tilbagebetalingstid (simpel):</strong></p>
              <div className="bg-muted p-3 rounded-md font-mono text-xs">
                <p>Tilbagebetaling = Systemomkostning / Årlig besparelse</p>
              </div>

              <p className="mt-4"><strong>Årlig besparelse:</strong></p>
              <div className="bg-muted p-3 rounded-md font-mono text-xs">
                <p>Egetforbrug-besparelse = Produktion × Egetforbrugsrate × Elpris</p>
                <p>Salg til net = Produktion × (1 - Egetforbrugsrate) × Salgspris</p>
                <p>Total besparelse = Egetforbrug-besparelse + Salg til net</p>
              </div>

              <p className="mt-4 text-muted-foreground">
                <strong>Salgspris til net:</strong> Vi antager 80% af detailprisen, som afspejler typiske danske
                afregningsaftaler.
              </p>
            </AccordionContent>
          </AccordionItem>

          <AccordionItem value="inflation">
            <AccordionTrigger>Inflation og fremskrivning</AccordionTrigger>
            <AccordionContent className="space-y-3 text-sm">
              <p>25-års fremskrivningen bruger følgende standardværdier:</p>

              <ul className="list-disc list-inside space-y-1">
                <li><strong>Generel inflation:</strong> 2% pr. år</li>
                <li><strong>El-prisstigning:</strong> 3% pr. år</li>
                <li><strong>Vedligeholdelse:</strong> 1.000 DKK/år (inflationsjusteret)</li>
              </ul>

              <p className="mt-4"><strong>Nominel vs. real værdi:</strong></p>
              <div className="bg-muted p-3 rounded-md font-mono text-xs">
                <p>// Nominel (faktiske DKK)</p>
                <p>Besparelse år N = Basis × (1 + elprisstigning)^N</p>
                <p className="mt-2">// Real (nutidens værdi)</p>
                <p>Real værdi = Nominel / (1 + inflation)^N</p>
              </div>

              <p className="text-muted-foreground mt-4">
                Du kan justere disse værdier under fanen "Avanceret".
              </p>
            </AccordionContent>
          </AccordionItem>

          <AccordionItem value="tax">
            <AccordionTrigger>Skattescenarier</AccordionTrigger>
            <AccordionContent className="space-y-3 text-sm">
              <p>
                <strong>Håndværkerfradrag (2026):</strong> Vi modellerer det danske håndværkerfradrag,
                som giver skattefradrag for arbejdsløn ved energiforbedringer.
              </p>

              <div className="bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 p-3 rounded-md">
                <p className="text-amber-800 dark:text-amber-200 font-medium">
                  ⚠️ Forbehold
                </p>
                <p className="text-amber-700 dark:text-amber-300 text-xs mt-1">
                  Skatteværdier er estimater baseret på historiske regler. De faktiske 2026-regler
                  bør verificeres med SKAT eller en skatteekspert før endelig beslutning.
                </p>
              </div>

              <ul className="list-disc list-inside space-y-1 mt-3">
                <li>Fradrag gælder kun for arbejdsløn (ikke udstyr)</li>
                <li>Maksimalt fradrag pr. år</li>
                <li>Afhænger af din skattesituation</li>
              </ul>
            </AccordionContent>
          </AccordionItem>

          <AccordionItem value="accuracy">
            <AccordionTrigger>Præcision og afrunding</AccordionTrigger>
            <AccordionContent className="space-y-3 text-sm">
              <p>
                Alle beregninger bruger <strong>Decimal.js</strong> med 20 cifres præcision for at sikre
                nøjagtighed i finansielle beregninger.
              </p>

              <ul className="list-disc list-inside space-y-1">
                <li>Ingen floating-point afrundingsfejl</li>
                <li>Resultaterne vises afrundet til 2 decimaler for læselighed</li>
                <li>Fuld præcision bevares i alle mellemregninger</li>
              </ul>

              <p className="text-muted-foreground mt-3">
                Denne metode er standard i finanssektoren og sikrer, at selv 25-års
                fremskrivninger ikke akkumulerer afrundingsfejl.
              </p>
            </AccordionContent>
          </AccordionItem>
        </Accordion>

        <div className="mt-6 pt-4 border-t text-center text-xs text-muted-foreground">
          <p>
            Beregningsmotor version 1.0.0 • Sidst opdateret: Januar 2026
          </p>
          <p className="mt-1">
            Har du spørgsmål til metoden?{' '}
            <a href="mailto:support@example.com" className="text-primary hover:underline">
              Kontakt os
            </a>
          </p>
        </div>
      </CardContent>
    </Card>
  );
}
```

Note: This requires the Accordion component from shadcn/ui. Install if not present:
```bash
npx shadcn@latest add accordion
```
  </action>
  <verify>
Run `npx tsc --noEmit` - MethodologyPanel compiles without errors.
  </verify>
  <done>
Methodology panel documents all assumptions including production calculation, degradation, inflation, and tax scenarios. Uses expandable accordion for progressive disclosure per CONTEXT.md decisions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create main Calculator component and page route</name>
  <files>
    components/calculator/Calculator.tsx
    app/calculator/page.tsx
  </files>
  <action>
Create components/calculator/Calculator.tsx:

```typescript
'use client';

import { useState } from 'react';
import { CalculatorTabs } from './CalculatorTabs';
import { CalculatorResults } from './CalculatorResults';
import { MethodologyPanel } from './MethodologyPanel';
import { useCalculatorForm } from '@/hooks/use-calculator-form';
import { Button } from '@/components/ui/button';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Calculator as CalculatorIcon, BookOpen, RotateCcw } from 'lucide-react';

export function Calculator() {
  const {
    input,
    updateField,
    updateFields,
    reset,
    validationErrors,
    isDirty,
  } = useCalculatorForm();

  const [activeView, setActiveView] = useState<'results' | 'methodology'>('results');

  // Check if we have enough valid data for calculations
  const hasValidInput = Object.keys(validationErrors).length === 0 && isDirty;

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <header className="border-b bg-card">
        <div className="container mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-primary/10 rounded-lg">
                <CalculatorIcon className="h-6 w-6 text-primary" />
              </div>
              <div>
                <h1 className="text-xl font-bold">Solcelleberegner</h1>
                <p className="text-sm text-muted-foreground">
                  Beregn afkast på din solcelleinvestering
                </p>
              </div>
            </div>

            <Button variant="outline" size="sm" onClick={reset}>
              <RotateCcw className="h-4 w-4 mr-2" />
              Nulstil
            </Button>
          </div>
        </div>
      </header>

      {/* Main content */}
      <main className="container mx-auto px-4 py-6">
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
          {/* Left: Inputs */}
          <div className="lg:col-span-5 xl:col-span-4">
            <div className="sticky top-6 space-y-4">
              <div className="bg-card border rounded-lg p-6">
                <CalculatorTabs />
              </div>

              {/* Quick summary when scrolling */}
              {isDirty && (
                <div className="bg-primary/5 border border-primary/20 rounded-lg p-4 text-sm">
                  <p className="font-medium text-primary">Indtastet:</p>
                  <p className="text-muted-foreground">
                    {input.roofAreaM2} m² tag • {input.electricityRateDkk.toFixed(2)} DKK/kWh •{' '}
                    {Math.round(input.selfConsumptionRate * 100)}% egetforbrug
                  </p>
                </div>
              )}
            </div>
          </div>

          {/* Right: Results */}
          <div className="lg:col-span-7 xl:col-span-8">
            {/* View toggle */}
            <div className="mb-4">
              <Tabs value={activeView} onValueChange={(v) => setActiveView(v as any)}>
                <TabsList>
                  <TabsTrigger value="results">
                    <CalculatorIcon className="h-4 w-4 mr-2" />
                    Resultater
                  </TabsTrigger>
                  <TabsTrigger value="methodology">
                    <BookOpen className="h-4 w-4 mr-2" />
                    Metode
                  </TabsTrigger>
                </TabsList>
              </Tabs>
            </div>

            {activeView === 'results' ? (
              <CalculatorResults input={input} enabled={hasValidInput} />
            ) : (
              <MethodologyPanel />
            )}
          </div>
        </div>
      </main>

      {/* Footer */}
      <footer className="border-t mt-12 py-6 text-center text-sm text-muted-foreground">
        <p>
          Alle beregninger er estimater. Få altid professionel rådgivning før køb.
        </p>
        <p className="mt-1">
          Beregningsmotor v1.0.0 • Data fra EU PVGIS
        </p>
      </footer>
    </div>
  );
}
```

Create app/calculator/page.tsx:

```typescript
import { Metadata } from 'next';
import { Calculator } from '@/components/calculator/Calculator';

export const metadata: Metadata = {
  title: 'Solcelleberegner | Beregn afkast på solceller',
  description:
    'Beregn tilbagebetalingstid, årlig besparelse og 25-års fremskrivning for din solcelleinvestering. Præcise beregninger med danske skattescenarier.',
  keywords: [
    'solceller',
    'solcelleberegner',
    'tilbagebetaling',
    'solenergi',
    'Danmark',
    'håndværkerfradrag',
  ],
};

export default function CalculatorPage() {
  return <Calculator />;
}
```
  </action>
  <verify>
Run `npm run build` - page builds successfully.
Run `npm run dev` and navigate to http://localhost:3000/calculator - page loads.
  </verify>
  <done>
Calculator page wires together inputs and results in responsive 2-column layout. Includes methodology panel toggle, reset button, and quick summary of current inputs.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 1 calculator functionality</name>
  <what-built>
Complete Phase 1 calculator with:
- Tabbed input collection (Essential, Energy, System, Advanced)
- Summary cards (payback, savings, cost, production)
- 25-year projection chart with nominal/real lines
- Cost breakdown with VAT
- Tax scenario comparison
- Methodology documentation panel
- All calculations using Decimal.js
- PVGIS integration for production estimates
  </what-built>
  <how-to-verify>
1. Navigate to http://localhost:3000/calculator
2. **Essential tab:**
   - Enter Copenhagen coordinates (55.68, 12.57)
   - Verify price area auto-detects to DK2
   - Adjust roof area to 60 m²
   - Move orientation slider to South (180°)
   - Move tilt slider to 35°

3. **Energy tab:**
   - Enter electricity rate: 2.50 DKK/kWh
   - Adjust self-consumption to 70%

4. **System tab:**
   - Enter costs: Panels 60000, Inverter 25000, Installation 45000, Mounting 12000
   - Verify VAT (25%) calculates correctly
   - Verify total shows ~177,500 DKK (with VAT)

5. **Results:**
   - Verify summary cards show payback period (~8-10 years expected)
   - Verify annual savings displayed
   - Click "Vis årsdata" in chart - verify 25 rows of data
   - Verify break-even year highlighted on chart
   - Click "Vis beregning" on cost breakdown - verify formula shown

6. **Tax scenarios:**
   - Verify two scenarios shown (with/without deduction)
   - Verify "Med håndværkerfradrag" shows lower effective cost

7. **Methodology tab:**
   - Click each accordion section
   - Verify formulas and assumptions documented

8. **Responsive:**
   - Resize browser to mobile width
   - Verify layout stacks properly

9. **Performance:**
   - Change inputs rapidly
   - Verify 500ms debounce (no lag during typing)
   - Verify results update after debounce period

Expected success: All Phase 1 success criteria met:
- [x] Location + roof → solar yield estimate
- [x] Transparent cost breakdown with VAT
- [x] 25-year projection with inflation
- [x] Decimal accuracy + "how calculated" visibility
- [x] Instant feedback with debouncing
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe specific issues to fix.</resume-signal>
</task>

</tasks>

<verification>
Phase 1 complete when all success criteria verified:
1. User can input location and roof details and receive solar yield estimate
2. User sees payback calculation with transparent cost breakdown
3. System shows 25-year financial projection with inflation adjustment
4. All calculations use Decimal type and user can see "how we calculated this"
5. Calculator provides instant feedback with debounced persistence
</verification>

<success_criteria>
- Calculator accessible at /calculator route
- All 4 input tabs functional with validation
- Summary cards display key metrics
- 25-year chart shows nominal and real savings
- Methodology panel documents all assumptions
- Human verification confirms complete functionality
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-core-calculations/01-07-SUMMARY.md`
</output>
