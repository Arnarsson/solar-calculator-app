---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - .env.example
  - lib/prisma.ts
  - lib/db/scenarios.ts
autonomous: true

must_haves:
  truths:
    - "Database uses PostgreSQL with NUMERIC/DECIMAL types for financial data"
    - "Schema supports saving calculation scenarios with all inputs"
    - "Formula version is tracked for auditability (DATA-05)"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "PostgreSQL schema with Decimal fields"
      contains: "postgresql"
    - path: "lib/db/scenarios.ts"
      provides: "Scenario CRUD operations"
      exports: ["saveScenario", "loadScenario"]
  key_links:
    - from: "lib/db/scenarios.ts"
      to: "prisma"
      via: "Prisma client queries"
      pattern: "prisma\\.(scenario|calculationInput)"
---

<objective>
Set up PostgreSQL database with Decimal-precision schema for financial calculations.

Purpose: Financial calculations require exact decimal precision. SQLite stores DECIMAL as float64 which causes drift in 25-year projections. PostgreSQL NUMERIC type provides exact precision required for 100K+ DKK purchase decisions.

Output: Production-ready database schema with Decimal fields, scenario storage, and formula versioning.
</objective>

<execution_context>
@/home/sven/.claude/get-shit-done/workflows/execute-plan.md
@/home/sven/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-and-core-calculations/01-RESEARCH.md

@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Prisma schema from SQLite to PostgreSQL with Decimal types</name>
  <files>
    prisma/schema.prisma
    .env.example
  </files>
  <action>
Update prisma/schema.prisma:
1. Change datasource provider from "sqlite" to "postgresql"
2. Add directUrl for connection pooling compatibility: `directUrl = env("DIRECT_DATABASE_URL")`
3. Update SetupCost model to use Decimal with @db.Decimal(12,2) for all financial fields
4. Add new CalculationScenario model with fields:
   - id (cuid)
   - name (String)
   - formulaVersion (String, default "1.0.0") - for DATA-05 auditability
   - createdAt, updatedAt timestamps
   - Relation to CalculationInput
5. Add CalculationInput model with fields:
   - Location: latitude (Decimal 10,7), longitude (Decimal 10,7), priceArea (String, "DK1" or "DK2")
   - Roof: roofAreaM2 (Decimal 8,2), azimuthDegrees (Decimal 5,2), tiltDegrees (Decimal 5,2)
   - System: systemCostDkk (Decimal 12,2), panelsCostDkk, inverterCostDkk, installationCostDkk (all Decimal 12,2)
   - Energy: electricityRateDkk (Decimal 6,4), selfConsumptionRate (Decimal 5,4), annualConsumptionKwh (Decimal 10,2)
   - Financial: inflationRate (Decimal 5,4), electricityInflationRate (Decimal 5,4), maintenanceCostDkk (Decimal 10,2)
6. Add YearlyProjection model (will store 25-year results):
   - scenarioId, year (1-25)
   - productionKwh, savingsNominalDkk, savingsRealDkk, cumulativeNominalDkk, cumulativeRealDkk (all Decimal)
   - @@unique([scenarioId, year])

Update .env.example with PostgreSQL connection string template:
```
DATABASE_URL="postgresql://user:password@host:5432/solar_calculator?sslmode=require"
DIRECT_DATABASE_URL="postgresql://user:password@host:5432/solar_calculator?sslmode=require"
```

Note: Keep existing User, Installation, MonthlyData models for backwards compatibility - they can be migrated later.
  </action>
  <verify>
Run `npx prisma validate` - should pass without errors.
Run `npx prisma format` - schema should be properly formatted.
  </verify>
  <done>
Prisma schema uses postgresql provider with Decimal fields. CalculationScenario and CalculationInput models exist with formulaVersion field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create scenario database operations with Decimal handling</name>
  <files>
    lib/db/scenarios.ts
    lib/prisma.ts
  </files>
  <action>
Create lib/db/scenarios.ts with scenario CRUD operations:

```typescript
import { prisma } from '@/lib/prisma';
import { Prisma } from '@prisma/client';

// Type for scenario creation (Prisma Decimal accepts string input)
export interface ScenarioInput {
  name: string;
  formulaVersion?: string;
  input: {
    latitude: string;
    longitude: string;
    priceArea: 'DK1' | 'DK2';
    roofAreaM2: string;
    azimuthDegrees: string;
    tiltDegrees: string;
    systemCostDkk: string;
    panelsCostDkk: string;
    inverterCostDkk: string;
    installationCostDkk: string;
    electricityRateDkk: string;
    selfConsumptionRate: string;
    annualConsumptionKwh: string;
    inflationRate: string;
    electricityInflationRate: string;
    maintenanceCostDkk: string;
  };
}

export async function saveScenario(userId: string, data: ScenarioInput) {
  return prisma.calculationScenario.create({
    data: {
      userId,
      name: data.name,
      formulaVersion: data.formulaVersion ?? '1.0.0',
      input: {
        create: {
          latitude: new Prisma.Decimal(data.input.latitude),
          longitude: new Prisma.Decimal(data.input.longitude),
          // ... map all fields to Prisma.Decimal
        }
      }
    },
    include: { input: true }
  });
}

export async function loadScenario(scenarioId: string) {
  return prisma.calculationScenario.findUnique({
    where: { id: scenarioId },
    include: { input: true, projections: true }
  });
}

export async function listUserScenarios(userId: string) {
  return prisma.calculationScenario.findMany({
    where: { userId },
    orderBy: { updatedAt: 'desc' },
    select: {
      id: true,
      name: true,
      formulaVersion: true,
      createdAt: true,
      updatedAt: true
    }
  });
}
```

Update lib/prisma.ts if needed to ensure singleton pattern works with new schema.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
Scenario CRUD operations exist in lib/db/scenarios.ts with proper Decimal handling. Functions accept string inputs and convert to Prisma.Decimal.
  </done>
</task>

<task type="auto">
  <name>Task 3: Install dependencies and generate Prisma client</name>
  <files>
    package.json
  </files>
  <action>
Install required dependencies for Phase 1:
```bash
npm install decimal.js use-debounce @tanstack/react-query
npm install -D fast-check @types/node
```

Generate Prisma client with new schema:
```bash
npx prisma generate
```

Note: Do NOT run `prisma db push` or `prisma migrate` - that requires actual database connection. This plan sets up the schema; database provisioning happens during deployment or local setup.
  </action>
  <verify>
Run `npm run build` - should complete without Prisma-related errors (may have other TypeScript errors from existing code, that's OK).
Check node_modules includes decimal.js, use-debounce, @tanstack/react-query, fast-check.
  </verify>
  <done>
All Phase 1 dependencies installed. Prisma client generated from new schema.
  </done>
</task>

</tasks>

<verification>
1. `npx prisma validate` passes
2. `npx tsc --noEmit` passes for new files
3. package.json includes: decimal.js, use-debounce, @tanstack/react-query, fast-check
4. Schema includes postgresql provider, Decimal fields, formulaVersion
</verification>

<success_criteria>
- PostgreSQL schema with Decimal precision for all financial fields
- CalculationScenario model with formulaVersion for auditability
- Scenario CRUD operations ready for use by calculation modules
- All Phase 1 npm dependencies installed
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-core-calculations/01-01-SUMMARY.md`
</output>
